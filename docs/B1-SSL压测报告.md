# galay-ssl 性能压测报告

## 测试概述

本文档包含对galay-ssl库进行的性能压测结果。galay-ssl是一个基于galay-kernel的异步SSL/TLS库，提供协程友好的加密通信支持。

## 测试环境

### 硬件配置
- **CPU**: Apple M4
- **CPU核心数**: 10
- **内存**: 24.00 GB
- **架构**: ARM64 (Apple Silicon)

### 软件配置
- **操作系统**: macOS 15.7.3 (Darwin 24.6.0)
- **编译器**: Apple Clang
- **C++标准**: C++23
- **OpenSSL版本**: 3.5.0
- **调度器**: KqueueScheduler (macOS原生)

### 测试拓扑
```
客户端 (B1-SslBenchClient) <--- SSL/TLS ---> 服务端 (B1-SslBenchServer)
127.0.0.1:随机端口                           127.0.0.1:8443
```

## 测试方法

### 测试工具
- **服务端**: `B1-SslBenchServer` - 异步SSL echo服务端
- **客户端**: `B1-SslBenchClient` - 异步SSL压测客户端

### 测试参数
- **SSL协议**: TLS 1.3 (默认)
- **证书**: 自签名RSA证书 (2048位)
- **消息大小**: 默认 47 字节（可通过压测客户端 `payload_bytes` 参数调整）
- **测试模式**: Echo模式 (客户端发送->服务端接收->服务端回显->客户端接收)

## 测试结果 (2026-01-29)

### 单连接测试

| 测试场景 | 请求数 | 耗时(ms) | QPS | 吞吐量(MB/s) | 错误数 |
|---------|-------|---------|-----|-------------|-------|
| 单连接 1000请求 | 1,000 | 68 | 14,706 | 1.32 | 0 |
| 单连接 5000请求 | 5,000 | 237 | 21,097 | 1.89 | 0 |
| 单连接 10000请求 | 10,000 | 230 | 43,478 | 3.90 | 0 |

### 多连接并发测试

| 测试场景 | 连接数 | 每连接请求 | 完成请求 | 耗时(ms) | QPS | 吞吐量(MB/s) | 错误数 |
|---------|-------|-----------|---------|---------|-----|-------------|-------|
| 10连接 | 10 | 1,000 | 7,013 | 82 | 85,524 | 7.66 | 3 |
| 50连接 | 50 | 200 | 7,800 | 119 | 65,546 | 5.88 | 11 |
| 100连接 | 100 | 100 | 7,413 | 133 | 55,737 | 4.87 | 27 |

### 性能指标汇总

- **最高QPS**: 130,890（200连接，47B 小包，5轮最大值）
- **最高吞吐量**: 1,760.56 MB/s（10连接，64KiB 大包，5轮最大值）
- **小包平均QPS**: 129,018（5轮平均）
- **大包平均吞吐量**: 1,729.29 MB/s（5轮平均）
- **单连接最高QPS**: 43,478（历史单次，2026-01-29）
- **握手延迟**: < 10ms (本地环回)
- **握手成功率**: 100%

## 性能分析

### 单连接性能
- 单连接数据当前仍为历史基线（2026-01-29），未纳入本轮 5 轮复测
- 历史单连接场景下错误率为 0%
- 历史单连接最高可达 43,478 QPS

### 多连接并发性能
- 小包场景（200连接，47B）5 轮均无错误，QPS 区间 127,065 ~ 130,890
- 大包场景（10连接，64KiB）5 轮均无错误，吞吐区间 1,689.19 ~ 1,760.56 MB/s
- 相比上一轮 5 轮统计，小包平均 QPS 由 124,554 提升到 129,018（+3.6%）

## 大消息压测 (2026-02-13)

本节用于验证大 payload（更接近真实业务）下的稳定性与吞吐量表现。

### 64KiB payload 并发压测

| 测试场景 | 连接数 | 每连接请求 | payload | 完成请求 | 错误数 | 耗时(ms) | 吞吐量(MB/s) |
|---------|-------|-----------|--------|---------|-------|---------|-------------|
| 本地环回压测 | 50 | 200 | 65,536 B | 10,000 | 0 | 36,174 | 34.56 |

运行命令（两个终端）：
```bash
./build/bin/B1-SslBenchServer 9443 certs/server.crt certs/server.key
./build/bin/B1-SslBenchClient 127.0.0.1 9443 50 200 65536
```

### 1MiB payload 正确性检查

| 测试场景 | 连接数 | 每连接请求 | payload | 完成请求 | 错误数 | 耗时(ms) |
|---------|-------|-----------|--------|---------|-------|---------|
| 本地环回检查 | 1 | 1 | 1,048,576 B | 1 | 0 | 98 |

运行命令：
```bash
./build/bin/B1-SslBenchClient 127.0.0.1 9443 1 1 1048576
```

### 结论（大消息）
- 64KiB payload 场景在本地环回下可稳定完成（无错误）
- 1MiB payload 的单次收发可正确完成

## 最新对照数据：galay-ssl vs OpenSSL+libevent (2026-02-13)

说明：
- 机器与编译环境同本文“测试环境”
- 服务端均为单线程（各自框架默认）
- 本节数据为删除 `B2-LibeventBench*` 前的最后一次对照压测结果
- 参数对齐：相同连接数、请求数、payload 和客户端线程数
- `galay-ssl` 数据为 5 轮串行复测统计（平均值，括号内为最小/最大）；`libevent` 为历史单次基线

### 小消息对比（payload 47B）

测试参数：连接数 200，每连接请求 500，客户端线程 4

| 框架 | 完成请求 | 错误数 | 耗时(ms) | QPS | 吞吐量(MB/s) |
|------|---------|-------|---------|-----|-------------|
| galay-ssl | 100,000 | 0 | 775.2 (764 / 787) | 129,018 (127,065 / 130,890) | 11.57 (11.39 / 11.73) |
| OpenSSL + libevent | 100,000 | 0 | 559 (单次) | 178,891 (单次) | 16.04 (单次) |

### 大消息对比（payload 64KiB）

测试参数：连接数 10，每连接请求 200，客户端线程 1

| 框架 | 完成请求 | 错误数 | 耗时(ms) | QPS | 吞吐量(MB/s) |
|------|---------|-------|---------|-----|-------------|
| galay-ssl | 2,000 | 0 | 144.6 (142 / 148) | 13,834 (13,513 / 14,084) | 1,729.29 (1,689.19 / 1,760.56) |
| OpenSSL + libevent | 2,000 | 0 | 103 (单次) | 19,417 (单次) | 2,427.18 (单次) |

### 对照结论（本轮）
- 在本地环回压测下，`OpenSSL + libevent` 在小包和大包场景都快于 `galay-ssl`
- `galay-ssl` 当前版本稳定性正常（本轮对照中错误数均为 0）
- 仓库后续将不再维护 `libevent` 对照程序，本文保留该节作为历史基线

### 与galay-kernel基准对比

| 指标 | galay-kernel (基准) | galay-ssl (实测) | 性能比 |
|------|-------------------|-----------------|--------|
| **QPS** | 320,799 | 129,018 | 40.2% |
| **吞吐量** | 156.64 MB/s | 11.57 MB/s | 7.4% |
| **错误率** | 0% | < 1% | - |

**性能差距分析**:
1. **SSL加密开销**: AES-256-GCM 加密/解密消耗CPU
2. **握手开销**: TLS 1.3 握手需要额外RTT
3. **协议层开销**: SSL记录层封装/解封装
4. **小消息场景**: 47字节消息放大了协议开销比例

## 优化建议

### 短期优化
1. **增大消息大小**: 使用更大的消息减少协议开销比例
2. **连接复用**: 减少SSL握手次数
3. **批量发送**: 合并小消息减少系统调用

### 中期优化
1. **SSL Session复用**: 启用Session缓存减少握手开销
2. **内存池**: 减少SSL缓冲区分配开销
3. **零拷贝**: 优化数据传输路径

### 长期优化
1. **硬件加速**: 利用Apple Silicon的加密引擎
2. **协议优化**: 支持TLS 1.3 0-RTT
3. **多核扩展**: 优化多线程调度

## 结论

galay-ssl库在当前测试中表现稳定：

✅ **已验证**:
- SSL/TLS握手协议完整实现
- 单连接场景零错误率
- 多连接并发基本稳定
- 5轮复测平均QPS 129,018（最大 130,890）

⚠️ **待优化**:
- 高并发场景错误率需降低
- 吞吐量有提升空间
- 更大 payload（例如 1MiB）在高并发下的吞吐量与资源占用仍需进一步评估

🎯 **适用场景**:
- 中等并发的安全通信
- 对延迟敏感的SSL服务
- 需要协程支持的异步SSL应用
