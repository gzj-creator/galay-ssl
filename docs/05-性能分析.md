# 性能分析

## 测试口径

- 场景：本地环回 SSL Echo（客户端发，服务端原样回）
- 构建：`Release + LTO`
- 服务端：`B1-SslBenchServer`
- 客户端：`B1-SslBenchClient`
- 记录日期：2026-02-13（最新 5 轮串行复测基线）

命令模板：

```bash
./build/bin/B1-SslBenchServer 9443 certs/server.crt certs/server.key
./build/bin/B1-SslBenchClient 127.0.0.1 9443 <connections> <requests> <payload_bytes> <threads>
```

## 关键指标

### 小包场景（47B，偏 QPS）

测试参数：`connections=200, requests_per_conn=500, payload=47, threads=4`

| 指标 | 数值 |
|------|------|
| 完成请求 | 100,000 |
| 错误数 | 0 |
| 耗时 | 616.4 ms（615 / 619） |
| QPS | 162,234（161,551 / 162,602） |
| 吞吐量 | 14.54 MB/s（14.48 / 14.58） |

### 大包场景（64KiB，偏吞吐）

测试参数：`connections=10, requests_per_conn=200, payload=65536, threads=1`

| 指标 | 数值 |
|------|------|
| 完成请求 | 2,000 |
| 错误数 | 0 |
| 耗时 | 126.2 ms（125 / 128） |
| QPS | 15,849（15,625 / 16,000） |
| 吞吐量 | 1,981.10 MB/s（1,953.12 / 2,000.00） |

说明：括号内为 5 轮串行复测中的最小值 / 最大值。

## 历史基线（归档）

为便于追踪优化趋势，仓库保留以下历史对照：

- 单连接基线（2026-01-29）
- `OpenSSL + libevent` 对照（已停止维护，仅历史参考）

详见：

- `docs/B1-SSL压测报告.md`
- `docs/T1-SSL测试结果.md`

## 性能观察

- 小包场景下，协议与调度开销占比高，QPS 对事件循环细节更敏感
- 大包场景下，吞吐主要受加解密和内存搬运影响
- 在当前基线中，错误数可控（核心场景 0 错误）
- `threads`、`payload` 与 `connect_retries` 对结果影响显著

## 常见瓶颈

1. TLS 加解密 CPU 开销
2. 大量小包导致系统调用和协议头开销放大
3. 高并发连接建立阶段的抖动（可通过 `connect_retries` 缓解）
4. 未开启 Release/LTO 的构建口径偏差

## 调优建议

### 1. 固定构建口径

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_LTO=ON
cmake --build build -j
```

### 2. 区分目标指标

- 追求 QPS：使用小 payload（如 47B）
- 追求吞吐：使用大 payload（如 64KiB）

### 3. 调整压测参数

- 优先保证 `errors=0`
- 再逐步提高 `connections` / `threads`
- 网络抖动明显时增加 `connect_retries`

### 4. 开启压测侧统计

```bash
GALAY_SSL_STATS=1 ./build/bin/B1-SslBenchClient 127.0.0.1 9443 50 200 47 4
```

可额外观察：

- `Send ops / send plain bytes`
- `Recv ops / recv plain bytes / recv chunks`
- `Avg recv chunk bytes`

## 复现建议

建议每组参数至少运行 5 轮，记录平均值和 min/max，避免单次抖动误导优化结论。
